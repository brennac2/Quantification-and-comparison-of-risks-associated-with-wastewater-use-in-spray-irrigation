---
title: Quantification and comparison of risks associated with wastewater use in spray irrigation
author: "Jameson Mori"
date: "7/17/2020"
output: html_document
---
LOAD PACKAGES
```{r,results="hide",echo=FALSE}
library(dplyr); library(lubridate); library(ggplot2); library(cowplot); library(gridExtra); library(plyr); library(plotly); library(openair); library(reshape2); library(fitdistrplus); library(EnvStats); library(sensitivity); library(readxl); library(formattable);
library(grid)
```
AGDISP INPUT CALCULATIONS AND OUTPUT FOR AERMOD
```{r}
##### UPLOAD AERMET WEATHER DATA #####
weather = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/AERMET_NC.SFC",skip=1,    
              width = c(2,3,3,4,3,7,7,7,7,6,6,9,8,7,7,8,7,7,7,7,6,7,7,7,6,21)) 

##### CALCULATE MEDIAN TEMPERATURE, WIND SPEED, HUMIDITY, AND SOLAR INSOLATION #####
# Select hours 6 am - 8 pm for May-September on days without precipitation   
# Solar insolation ---  4/10 or less (<3/8), 5-8/10 (thinly overcast), 9-10/10 (overcast)
w = weather %>% filter(between(V2,5,9),between(V5,6,20),V21==0)   
w2 = w[,c(16,19,23,25)]
colnames(w2) = c("ws","temp","hum","s")
w2$temp = (((w2$temp-273.15)*9)/5)+32   # convert temperature from Kelvin to Fahrenheit
w3 = w2 %>% filter(between(temp,0,110) & between(hum,0,100) & between(ws,0,20) & between(s,0,10))  # remove instrument errors 
apply(w3[,1:3],2,median)  

s = as.factor(w3$s)  # convert format of cloud cover from numeric to factor
count(s)  # find the frequency of each cloud cover level --- usually thinly or completely overcast

##### AERMOD INPUT CALCULATIONS #####
# Upload AgDisp droplet size distribution output file 
am = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/AgDisp/AgDisp Metadata.txt",skip=3,width=c(11,12))
colnames(am) = c("vf","size")
pa = am %>% filter(size < 11)  # subset matrix for pathogens (up to ~10 um in size) 

##### RELATIVE VOLUME FRACTIONS (PATHOGENS) #####
pa_t = sum(pa$vf)  # total volume fraction
pa2 = pa %>% mutate(cvf = round(vf/pa_t,5))   # relative volume fractions

##### RELATIVE VOLUME FRACTIONS (AMMONIA) #####
# Averaged droplets within 3 um in diameter for easier AERMOD processing
am_t = sum(am$vf)  # total volume fraction
am2 = am %>% mutate(cvf = vf/am_t)  # raw relative volume fractions
amsize = c(mean(c(am2[1,2],am2[2,2])),mean(c(am2[3,2],am2[4,2],am2[5,2])),mean(c(am2[6,2],am2[7,2])),mean(c(am2[8,2],am2[9,2])),
	mean(c(am2[10,2],am2[11,2])),am2[12,2],mean(c(am2[13,2],am2[14,2])),mean(c(am2[15,2],am2[16,2],am2[17,2])),mean(c(am2[18,2],am2[19,2])),
	mean(c(am2[20,2],am2[21,2],am2[22,2])),mean(c(am2[23,2],am2[24,2],am2[25,2])),
	mean(c(am2[26,2],am2[27,2],am2[28,2])),am2[29,2],am2[30,2],am2[31,2])
asize = round(amsize,2)  # average droplet diameters 

amcvf = c(sum(c(am2[1,3],am2[2,3])),sum(c(am2[3,3],am2[4,3],am2[5,3])),sum(c(am2[6,3],am2[7,3])),sum(c(am2[8,3],am2[9,3])),
	sum(c(am2[10,3],am2[11,3])),am2[12,3],sum(c(am2[13,3],am2[14,3])),sum(c(am2[15,3],am2[16,3],am2[17,3])),sum(c(am2[18,3],am2[19,3])),
	sum(c(am2[20,3],am2[21,3],am2[22,3])),sum(c(am2[23,3],am2[24,3],am2[25,3])),
	sum(c(am2[26,3],am2[27,3],am2[28,3])),am2[29,3],am2[30,3],am2[31,3])
acvf = round(amcvf,4)  # relative volume fractions 

##### EMISSION RATE FOR INDIVIDUAL SOURCES #####
# These values are used in AERMOD for the dispersion model
ue = (850*3785.41)/60  # uncorrected total emission rate (US gal/min to gram/sec)
ae = round((ue*am_t)/53,0)  # emission rate for each nozzle (AMMONIA) rounded to a whole number
pe = round((ue*pa_t)/53,0)  # emission rate for each nozzle (PATHOGENS) rounded to a whole number
```
PLOT DOWNWIND DROPLET SIZE DISTRIBUTION
```{r}
dm1 = c(10.77,16.73,19.39,22.49,26.05,30.21,35.01,40.57,47.03,54.5,
	63.16,73,23,84.85,98.12,113.71,131.73,152.79,177.84,205.84,238.45,
	276.48,320.6,430.74,498.91,578.54,670.72,777.39,900.61,1044.42,1210.66,1403.04)
cm1 = c(0.0005,0.0002,0.0003,0.0002,0.0003,0.0005,0.0007,0.0012,0.0022,0.004,0.0058,0.0077,0.0095,0.0147,0.0227, 0.0305,0.0403,0.0513,
	0.063,0.089,0.1077,0.1308,0.1262,0.0993,0.0795,0.0567,0.0278,0.011,0.0055,0.0045,0.0035,0.003)
m1.1 = cbind(rep("B",32),dm1,cm1) 
m1.2 = as.data.frame(m1.1)
colnames(m1.2) = c("V","d","c")
m1.2$d = as.numeric(as.character(m1.2$d))
m1.2$c = as.numeric(as.character(m1.2$c))

dm2 = c(26.05,30.21,35.01,40.57,47.03,54.5,63.16,98.12,113.71,
	131.73,152.79,177.84,205.84,238.45)
cm2 = c(3.331038E-02,7.289351E-02,9.726348E-02,0.1316917,0.1724566,
	7.185525E-02,0.0369875,0.0369875,0.0369875,7.397498E-02,6.611475E-02,
	9.035686E-02,6.297677E-02,1.614323E-02)
m2.1 = cbind(rep("A",14),dm2,cm2)
m2.2 = as.data.frame(m2.1)
colnames(m2.2) = c("V","d","c")
m2.2$d = as.numeric(as.character(m2.2$d))
m2.2$c = as.numeric(as.character(m2.2$c))
M = rbind(m1.2,m2.2)
M2 = melt(M,id.vars = c("V","d"))

plot = ggplot(M2,aes(x=d,y=value,group=V,color=V))+geom_point(size=2)+geom_line(size=1)+theme_bw()+
	labs(x="Droplet Diameter (microns)",y="Relative Volume Fraction")+
	theme(axis.title.x = element_text(face="bold",vjust=-0.5),
	axis.title.y = element_text(face="bold",vjust=2),panel.grid = element_blank(),legend.title = element_blank(),
	legend.position = c(0.78,0.9),legend.text = element_text(size=11))+
	scale_x_continuous(n.breaks = 10)+scale_y_continuous(n.breaks=10)+
	scale_color_manual(values = c("dark grey","black"),labels=c("ASABE Medium","Downwind")); plot
```
AERMOD AIR CONCENTRATION OUTPUT FOR BOTH SOURCE ORIENTATIONS
Two different AERMOD runs are processed:
	(1) Cartesian grid of receptors 500 meters around the source
	(2) Polar network of receptors 2000 meters from the center of the source (indicated with "far" in the name)
Processing:
	Subtract an hour from the datetime to preserve the date and convert to date 
  Select only days without precipitation (no irrigation)
  Select days between May 1 and September 30 for the years 2013-2018 (irrigation season)
  Remove air concentration predictions from receptors on the irrigator itself
```{r}
##### PATHOGEN AIR CONCENTRATIONS (<500 m) #####
nspath = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/Dispersion Model/NSPATH/NS_PATH.PLT",
	skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
nsp = nspath[,c(1,2,3,5,11)]
colnames(nsp) = c("x","y","c","wdep","date")  # select and rename columns of interest
nsp_2 = nsp %>% mutate(date2=date-1,datetime=ymd_h(date2)) %>% filter(wdep==0) %>%  
  filter(between(datetime,as.POSIXct("2013-05-01 1:00:00"),as.POSIXct("2013-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2014-05-01 1:00:00"),as.POSIXct("2014-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2015-05-01 1:00:00"),as.POSIXct("2015-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2016-05-01 1:00:00"),as.POSIXct("2016-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2017-05-01 1:00:00"),as.POSIXct("2017-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2018-05-01 1:00:00"),as.POSIXct("2018-09-30 23:00:00"))) %>%
  filter(!between(x,0,15)&!between(y,0,800))
nsp2 = nsp_2[,3]

ewpath = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/Dispersion Model/EWPATH/EW_PATH.PLT",
	skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
ewp = ewpath[,c(1,2,3,5,11)] 
colnames(ewp) = c("x","y","c","wdep","date")  # select and rename columns of interest
ewp_2 = ewp %>% mutate(date2=date-1,datetime=ymd_h(date2)) %>% filter(wdep==0) %>%  
  filter(between(datetime,as.POSIXct("2013-05-01 1:00:00"),as.POSIXct("2013-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2014-05-01 1:00:00"),as.POSIXct("2014-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2015-05-01 1:00:00"),as.POSIXct("2015-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2016-05-01 1:00:00"),as.POSIXct("2016-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2017-05-01 1:00:00"),as.POSIXct("2017-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2018-05-01 1:00:00"),as.POSIXct("2018-09-30 23:00:00"))) %>%
  filter(!between(x,0,800)&!between(y,0,15))
ewp2 = ewp_2[,3]

path = rbind(nsp2,ewp2)  # combine the predicted air concentrations for the 500 meter grid into 1 vector 

##### PATHOGEN AIR CONCENTRATIONS (1.6-2 KM) #####
nsp_far = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/NSPATHLONG/NS_PATH_LONG.PLT",
	skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
nspfar = nsp_far[,c(1,2,3,5,11)] 
colnames(nspfar) = c("x","y","c","wdep","date")
nspfar2 = nspfar %>% mutate(date2=date-1,datetime=ymd_h(date2)) %>% filter(wdep==0) %>%  
  filter(between(datetime,as.POSIXct("2013-05-01 1:00:00"),as.POSIXct("2013-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2014-05-01 1:00:00"),as.POSIXct("2014-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2015-05-01 1:00:00"),as.POSIXct("2015-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2016-05-01 1:00:00"),as.POSIXct("2016-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2017-05-01 1:00:00"),as.POSIXct("2017-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2018-05-01 1:00:00"),as.POSIXct("2018-09-30 23:00:00"))) 
nspfar3 = nspfar2[,3]

ewp_far = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/EWPATHLONG/EW_PATH_LONG.PLT",
											skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
ewpfar = ewp_far[,c(1,2,3,5,11)]
colnames(ewpfar) = c("x","y","c","wdep","date")
ewpfar2 = ewpfar %>% mutate(date2=date-1,datetime=ymd_h(date2)) %>% filter(wdep==0) %>%  
  filter(between(datetime,as.POSIXct("2013-05-01 1:00:00"),as.POSIXct("2013-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2014-05-01 1:00:00"),as.POSIXct("2014-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2015-05-01 1:00:00"),as.POSIXct("2015-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2016-05-01 1:00:00"),as.POSIXct("2016-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2017-05-01 1:00:00"),as.POSIXct("2017-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2018-05-01 1:00:00"),as.POSIXct("2018-09-30 23:00:00")))
ewpfar3 = ewpfar2[,3]

pathfar = rbind(nspfar3,ewpfar3)  # combine the predicted air concentrations into 1 vector
save(path,pathfar,file="pathair.RData"); save(path,pathfar,file="pathair.txt")  # save the two pathogen air concentration vectors

##### AMMONIA AIR CONCENTRATIONS (<500 m) #####
nsam = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/Dispersion Model/NSAMM/NS_AMMONIA.PLT",
	skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
nsa = nsam[,c(1,2,3,5,11)]
colnames(nsa) = c("x","y","c","wdep","date")
nsa2 = nsa %>% mutate(date2=date-1,datetime=ymd_h(date2)) %>% filter(wdep==0) %>%  
  filter(between(datetime,as.POSIXct("2013-05-01 1:00:00"),as.POSIXct("2013-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2014-05-01 1:00:00"),as.POSIXct("2014-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2015-05-01 1:00:00"),as.POSIXct("2015-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2016-05-01 1:00:00"),as.POSIXct("2016-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2017-05-01 1:00:00"),as.POSIXct("2017-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2018-05-01 1:00:00"),as.POSIXct("2018-09-30 23:00:00"))) %>%
  filter(!between(x,0,15)&!between(y,0,800))
nsa3 = nsa2[,3]

ewam = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/Dispersion Model/EWAMM/EW_AMMONIA.PLT",
	skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
ewa = ewam[,c(1,2,3,5,11)]
colnames(ewa) = c("x","y","c","wdep","date")
ewa2 = ewa %>% mutate(date2=date-1,datetime=ymd_h(date2)) %>% filter(wdep==0) %>%  
  filter(between(datetime,as.POSIXct("2013-05-01 1:00:00"),as.POSIXct("2013-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2014-05-01 1:00:00"),as.POSIXct("2014-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2015-05-01 1:00:00"),as.POSIXct("2015-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2016-05-01 1:00:00"),as.POSIXct("2016-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2017-05-01 1:00:00"),as.POSIXct("2017-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2018-05-01 1:00:00"),as.POSIXct("2018-09-30 23:00:00"))) %>%
  filter(!between(x,0,800)&!between(y,0,15)) 
ewa3 = ewa2[,3]

amm = rbind(nsa3,ewa3)  # save the predicted air concentrations into 1 vector

##### AMMONIA AIR CONCENTRATIONS (1.6-2 KM) #####
nsamfar = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/NSAMLONG/NS_AMMONIA_LONG.PLT",
	skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
nsafar = nsamfar[,c(1,2,3,5,11)]
colnames(nsafar) = c("x","y","c","wdep","date")

nsafar2 = nsafar %>% mutate(date2=date-1,datetime=ymd_h(date2)) %>% filter(wdep==0) %>%  
  filter(between(datetime,as.POSIXct("2013-05-01 1:00:00"),as.POSIXct("2013-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2014-05-01 1:00:00"),as.POSIXct("2014-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2015-05-01 1:00:00"),as.POSIXct("2015-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2016-05-01 1:00:00"),as.POSIXct("2016-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2017-05-01 1:00:00"),as.POSIXct("2017-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2018-05-01 1:00:00"),as.POSIXct("2018-09-30 23:00:00"))) 
nsafar3 = nsafar2[,3]

ewamfar = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/EWAMLONG/EW_AMMONIA_LONG.PLT",
	skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
ewafar = ewamfar[,c(1,2,3,5,11)]
colnames(ewafar) = c("x","y","c","wdep","date")

ewafar2 = ewafar %>% mutate(date2=date-1,datetime=ymd_h(date2)) %>% filter(wdep==0) %>%  
  filter(between(datetime,as.POSIXct("2013-05-01 1:00:00"),as.POSIXct("2013-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2014-05-01 1:00:00"),as.POSIXct("2014-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2015-05-01 1:00:00"),as.POSIXct("2015-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2016-05-01 1:00:00"),as.POSIXct("2016-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2017-05-01 1:00:00"),as.POSIXct("2017-09-30 23:00:00"))|
           between(datetime,as.POSIXct("2018-05-01 1:00:00"),as.POSIXct("2018-09-30 23:00:00"))) 
ewafar3 = ewafar2[,3]

amfar = rbind(nsafar3,ewafar3)  # save the predicted air concentrations into 1 vector

save(amm,amfar,file="ammair.RData"); save(amm,amfar,file="ammair.txt")  # save the air concentrations for ammonia
```
CONTOUR PLOT AND WIND ROSE
```{r}
### Contour Plot ###
p1 = rbind(nsp_2,ewp_2)  # combine into 1 matrix to account for unknown irrigator location
p2 = ddply(p1,.(x,y),summarize,mean=mean(c)/10^6)  # mean air concentration at each receptor and convert to grams/m^3
plot = plot_ly(x=p2$x,y=p2$y,z=p2$mean,type="contour") %>% colorbar(title="Concentration\n (g/m^3)") %>%
	layout(xaxis=list(title="(Distance in meters)",size=20,color="black")); plot  # contour plot

### Wind Rose ###
weather = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/AERMET_NC.SFC",skip=1,    # load AERMET weather data
              width = c(2,3,3,4,3,7,7,7,7,6,6,9,8,7,7,8,7,7,7,7,6,7,7,7,6,21))  
w = weather %>% filter(between(V2,5,9) & V21==0 & between(V16,0,20))  # select relevant months, no precipitation, and remove errors
rose = windRose(w,ws="V16",wd="V17",paddle=FALSE,cols = "heat",annotate = "",ylab=NULL)  # wind rose
```
EMPIRICAL PARAMETER GENERATION FOR RISK ASSESSMENT
```{r}
rm(list=ls())   # clear large datasets from workspace
load("pathair.RData"); load("ammair.RData")  # load the necessary saved datasets

##### BACTERIAL SOURCE CONCENTRATIONS (GENE COPIES/L) #####
data = read_xlsx("C:/Users/brenn/Box Sync/Dispersion Modeling/pathogen concentrations.xlsx")  
bac = data[,c(6,9)] %>% na.omit()  # select relevant variables
LP = bac$`Legionella pneumophila (mip)...9` 
M = bac$`Mycobacteria (atpE)...6`
M2 = as.numeric(na.omit(M))

##### DAILY EXPOSURE DURATION (HOURS/DAY) #####
set.seed(101)
E = data.frame(c(runif(110,1,4),runif(311,5,9),runif(902,10,14),runif(281,15,24)))  # uniform distributions based on survey results
colnames(E) = "E"
E2 = as.numeric(E$E)
x2 = fitdist(E2,"norm"); plot(x2); summary(x2) # easier to fit than truncated normal and yielded same results9

##### ALVEOLAR DEPOSITION (dep=RR) #####
depx = c(0.483,0.425,0.35,0.3,0.25,0.175,0.1)  # dep fraction
depy = c(5e-4,2e-4,3e-4,2e-4,3e-4,5e-4,7e-4)  # volume fractions of each particle size category from trajectory files
depk = depy*depx
dep = depk/sum(depk)  # fractions of each particle size that would be deposited in the alveoli if inhaled --- input for RR parameter

##### NUMBER OF IRRIGATION EVENTS #####
irf = c(7,9,8,5,4,5,8,8,6,5,8,6,5,8,6,8,10,12,11,6,5,10,14,11,7,10,7,          # irrigation frequency (days)
				9,10,9,5,5,4,9,12,10,6,9,5,6,8,10,9,4,4,4,9,12,10,9,6,7,9,6,4,7,
				6,9,8,9,8,4,4,8,11,9,6,8,6,6,4,8,4,4,3,7,9,8,7,5,5,7,5,10,4,
				6,5,7,5,3,6,5,3,3,3,5,7,6,5,4,4,5,4,8,4,5,4,5,7,9,8,4,4,4,8,8,6,5,
				6,8,6,4,7,6,8,4,7,9,8,4,4,3,7,7,5,5,6,7,5,4,7,5,7)
N = 153/irf     # (length of irrigation season/irrigation events)

##### BACTERIAL DECAY CORRECTION FACTORS #####
weather = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/AERMET_NC.SFC",skip=1,   # upload AERMET weather data
              width = c(2,3,3,4,3,7,7,7,7,6,6,9,8,7,7,8,7,7,7,7,6,7,7,7,21)) 
w_s = weather %>% filter(between(V2,5,9))  # choose wind speed column for wind speeds May-September
ws = w_s[,16]
ws[ws==999] = NA  # recode missing values
ws2 = na.omit(ws)  # remove NA's 
wind = as.numeric(ws2)  # convert to a numeric vector
set.seed(320)
l_d = c(runif(1000,8.4e-5,2.38e-4),runif(1000,1.82e-4,3.09e-4),runif(1000,7.88e-5,4.09e-4))  # L. pneumophila decay rates
l_d = as.numeric(l_d)
descdist(l_d)
l_d2 = fitdist(l_d,"beta"); summary(l_d2)  # shape1 = 7.8653; shape2 = 36341.1814

##### AIR CONCENTRATION INFORMATION #####
am = data.frame(amm)
count(am$c)  

pa = data.frame(path)
count(pa$c)   

# Latin Hypercube sample wind speed, decay rates, and distance from source 
micro = data.frame(simulateMvMatrix(1000,distributions = c(ld="beta",md="unif",dist="unif",wind="emp"),
	param.list = list(ld=list(shape1=7.8653,shape2=36341.1814),md=list(min=0.6/3600,max=6.9/3600),dist=list(min=50,max=500),
										wind=list(obs=wind)),sample.method = "LHS",seed = 643))

# Calculate microbial decay correction factors 
dist = micro[,3]  # distance of individual from source
L.D = function(dist){
	micro = micro
	LD = exp(-micro[,1]*(dist/micro[,4]))   # exp(-decay rate*(distance/wind speed))
}
ld = sapply(dist,L.D)  # distribution of decay factors for each distance  
LD = apply(ld,2,mean)  # microbial decay adjustment factor for L. pneumophila
descdist(LD)  # uniform --- min (0.8307) & max (0.857)  

M.D = function(dist){
	micro = micro
	MD = exp(-micro[,2]*(dist/micro[,4]))  
}
md = sapply(dist,M.D)  # distribution of decay factors for each distance
MD = apply(md,2,mean)  # microbial decay adjustment factor for NTM
descdist(MD)  # uniform; min (0.7302) & max (0.8456)

save(LP,M,LD,MD,dep,N,file="emp_param.RData")  # save empirical parameters
```
HISTOGRAMS OF BACTERIAL SOURCE CONCENTRATIONS
```{r}
LP = data.frame(LP)
lp = ggplot(LP,aes(x=LP))+geom_histogram(fill="black")+theme_bw()+theme(axis.title = element_blank())+
	theme(panel.grid = element_blank())+scale_y_continuous(limits = c(0,80))+
	scale_x_continuous(breaks=seq(0,7000,1000),labels = scales::scientific); lp

M = data.frame(M)
ntm = ggplot(M,aes(x=M))+geom_histogram(fill="black")+theme_bw()+theme(axis.title = element_blank())+
	theme(panel.grid = element_blank())+scale_y_continuous(limits = c(0,80)); ntm

x.lab = textGrob("Source Concentration of Bacteria (gc/L)",gp=gpar(fontface="bold",fontsize=12)) # shared x-axis label
y.lab = textGrob("Frequency",gp=gpar(fontface="bold",fontsize=13),rot=90)  # shared y-axis label

sc = plot_grid(lp,ntm,ncol=2,labels=c("(L. pneumophila)","(Mycobacteria spp.)"),axis = "l",
	label_x = c(0.55,0.47),label_size = 13,label_y = c(0.98,0.98),label_fontface = "italic")  # combine histograms into 1 plot 
sc2 = grid.arrange(arrangeGrob(sc,left=y.lab,bottom=x.lab)); sc2  # add shared labels to the histogram plot
```
QUANTITATIVE MICROBIAL RISK ASSESSMENT 
```{r}
rm(list=ls())
load("emp_param.RData"); load("pathair.RData"); load("ammair.RData") 
path2 = as.data.frame(t(path))
p = c(path2$nsp2,path2$ewp2)
pathfar2 = as.data.frame(t(pathfar))
pf = c(pathfar2$nspfar3,pathfar2$ewpfar3)

amm2 = as.data.frame(t(amm))
a = c(amm2$nsa3,amm2$ewa3)
amfar2 = as.data.frame(t(amfar))
af = c(amfar2$nsafar3,amfar2$ewafar3)

rlp = c(0.06,0.06)  # Legionella dose-response parameter

##### LATIN HYPERCUBE SAMPLING OF INPUT PARAMETERS #####
# P is percent wastewater used in irrigation, dep is fraction of aerosol deposited in alveoli, I is inhalation rate
# nh is source concentration of ammonia
parm = data.frame(simulateMvMatrix(1000,distributions=c(pair="emp",E="normTrunc",rlp="emp",rm="unif",LP="emp",M="emp",
  P="unif",dep="emp",I="unif",N="emp",nh="unif",LD="emp",MD="emp",aair="emp",pfair="emp",afair="emp"),
	param.list=list(pair=list(obs=p),E=list(mean=11.7,sd=4.8,min=0,max=24),rlp=list(obs=rlp),rm=list(min=3.12e-9,max=1.1e-6),LP=list(obs=LP),
	M=list(obs=M),P=list(min=0.01,max=0.2),dep=list(obs=dep),I=list(min=0.6,max=1.5),N=list(obs=N),nh=list(min=500,max=1800),
	LD=list(obs=LD),MD=list(obs=MD),aair=list(obs=a),pfair=list(obs=pf),afair=list(obs=af)),
	sample.method="LHS",seed=250))
save(parm,file="LHS.RData")

##### LEGIONELLA RISK ASSESSMENT --- WITHIN 500 METERS #####
# Probability of infection per irrigation event --- 1-exp(-rlp*(air*I*LP*E*P*dep*LD*dw)/9.97e8) --- 9.97e8 is for the unit conversions
# Annual probability of infection --- calculate the annual probability of infection from sampling of single event probabilities 
# pair (1) - E (2) - rlp (3) - LP (5) - P (7) - dep (8) - I (9) - D (10) - LD (12)
lpd = 1-exp(-parm[,3]*((parm[,1]*parm[,9]*parm[,5]*parm[,2]*parm[,7]*parm[,8]*parm[,12])/9.97e8))

N = round(parm[,10],0)  # round number of irrigation events/year to a whole number because it's a discrete variable
lpd2 = data.frame(lpd)
lp.year = function(lpd2){
  z = function(D){
    lpk = sample(lpd2,N,replace=TRUE)   # choose number of single infection probabilities equal to the number of irrigation events for a year 
    lpyear = 1-prod(1-lpk)  # find the product of 1 minus each single infection probability and subtract from 1
  }
  z2 = sapply(N,z)  # get the annual probability of infection for each possible number of irrigation events
}
set.seed(770)
lpy = as.numeric(apply(lpd2,2,lp.year))  # annual probability of infection considering different single event infection probabilities 

##### MYCOBACTERIA RISK ASSESSMENT --- WITHIN 500 METERS #####
# Probability of infection per irrigation event --- 1-exp(-rm*(air*I*M*E*P*dep*MD)/9.97e8) --- 9.97e8 is for the unit conversions
# pair (1) - E (2) - rm (4) - M (6) - P (7) - dep (8) - I (9) - D (10) - MD (13) 
m_d = data.frame(1-exp(-parm[,4]*((parm[,1]*parm[,9]*parm[,6]*parm[,2]*parm[,7]*parm[,8]*parm[,13])/9.97e8)))
m.year = function(m_d){  # annual infection probability
  z = function(N){
    mk = sample(m_d,N,replace=TRUE)
    myear = 1-prod(1-mk)
  }
  z2 = sapply(N,z)
}
set.seed(770)
my = as.numeric(apply(m_d,2,m.year))  # annual probability of infection considering different single event infection probabilities 

##### AMMONIA AIR CONCENTRATION ASSESSMENT --- WITHIN 500 METERS #####
# Predicted air concentrations of ammonia from the wastewater (mg/m3) --- nh*air*P [10^9 is for unit conversions]
# P (7) - nh (11) - aair (14)
amc = (parm[,11]*parm[,14]*parm[,7])/(10^9)

##### LEGIONELLA RISK ASSESSMENT --- 2000 METERS (FAR) #####
# pfair (15) - E (2) - rlp (3) - LP (5) - P (7) - dep (8) - I (9) - D (10) - LD (12) 
lpd2 = data.frame(1-exp(-parm[,3]*((parm[,15]*parm[,9]*parm[,5]*parm[,2]*parm[,7]*parm[,8]*parm[,12])/9.97e8)))  
lp.year2 = function(lpd2){
  z = function(N){
    lpk = sample(lpd2,N,replace=TRUE)   # choose number of single infection probabilities equal to the number of irrigation events for a year 
    lpyear = 1-prod(1-lpk)  # find the product of 1 minus each single infection probability and subtract from 1
  }
  z2 = sapply(N,z)  # get the annual probability of infection for each possible number of irrigation events
}
set.seed(770)
lpy2 = as.numeric(apply(lpd2,2,lp.year2))  # annual probability of infection considering different single event infection probabilities 

##### MYCOBACTERIA RISK ASSESSMENT --- 2000 METERS (FAR) #####
# Probability of infection per irrigation event --- 1-exp(-rm*(air*I*M*E*P*dep*MD)/9.97e8) --- 9.97e8 is for the unit conversions
# pfair (15) - E (2) - rm (4) - M (6) - P (7) - dep (8) - I (9) - D (10) - MD (13) 
m_d2 = data.frame(1-exp(-parm[,4]*((parm[,15]*parm[,9]*parm[,6]*parm[,2]*parm[,7]*parm[,8]*parm[,13])/9.97e8)))
m.year2 = function(m_d2){  # annual infection probability
  z = function(N){
    mk = sample(m_d2,N,replace=TRUE)
    myear = 1-prod(1-mk)
  }
  z2 = sapply(N,z)
}
set.seed(770)
my2 = as.numeric(apply(m_d2,2,m.year2))  # annual probability of infection considering different single event infection probabilities 
```
QMRA RESULTS TABLE
```{r}
stats = data.frame(cbind(lpy,lpy2,my,my2))
stats2 = melt(stats,measure.vars=colnames(stats))
stats3 = ddply(stats2,.(variable),summarize,median=median(value),Q95=quantile(value,0.95),max=max(value))  
x = c("L.pneumophila (500 m)","L. pneumophila (1.6-2 km)","NTM (500 m)","NTM (1.6-2 km)")
stats4 = cbind(x,stats3)
stats5 = stats4[,c(1,3:5)]
colnames(stats5) = c("Exposure Scenario","Median","95th Percentile","Maximum")
rownames(stats5) = c()
stats5$Median = formatC(stats5$Median,format="e",digits=3)
stats5$`95th Percentile` = formatC(stats5$`95th Percentile`,format="e",digits=3)
stats5$Maximum = formatC(stats5$Maximum,format="e",digits=3)
table = formattable(stats5,align=c("l","c","c","c")); table
```
STRIP CHARTS OF FINAL RISK DISTRIBUTIONS
```{r}
##### STRIP CHARTS OF RESULTS #####
l.labels = rep("L",1000)  # labels for Legionella 
lpy3 = data.frame(cbind(l.labels,lpy,lpy2))  # create matrix of Legionella results and labels
lpy3$lpy = as.numeric(as.character(lpy3$lpy))  # convert from factor to numeric
lpy3$lpy2 = as.numeric(as.character(lpy3$lpy2))  # convert from factor to numeric
colnames(lpy3) = c("Label","L1","L2")  # rename columns
lbac = melt(lpy3,id.vars = "Label",measure.vars = c("L1","L2"))  # make the matrix tidy

count(lpy3$L1 >= 1e-4)  # 6.8%
count(lpy3$L2 >= 1e-4)  # 0%

m.labels = rep("M",1000)  # labels for Mycobacteria
my3 = data.frame(cbind(m.labels,my,my2))  # matrix of Mycobacteria results and labels
my3$my = as.numeric(as.character(my3$my))  
my3$my2 = as.numeric(as.character(my3$my2))
colnames(my3) = c("Label","M1","M2")
mbac = melt(my3,id.vars="Label",measure.vars=c("M1","M2"))  # make the matrix tidy
bac = rbind(lbac,mbac)  # make a tidy matrix for the bacteria risk results

set.seed(299)  
bacplot = ggplot(bac,aes(x=variable,y=value,color=Label))+geom_jitter(width=0.3)+geom_hline(yintercept = 1e-4,linetype="dashed",size=1)+
	theme_bw()+labs(x=NULL,y="Annual Probability of Infection")+theme(axis.title.y=element_text(face="bold",size=12,hjust=0.5,vjust=2.7))+
	scale_x_discrete(labels=c("Legionella \n (500 m)","Legionella \n (1.6-2 km)","Mycobacteria \n (500 m)","Mycobacteria \n (1.6-2 km)"))+
	theme(axis.text.x = element_text(face="bold",color="black",size=10),legend.title = element_blank(),legend.position = "none")+
	theme(panel.grid = element_blank())+
	scale_color_manual(labels=c("Legionella","Mycobacteria"),values=c("black","dark grey")); bacplot
```
AMMONIA AIR CONCENTRATION ASSESSMENT
```{r}
# Predicted air concentrations of ammonia from the wastewater (mg/m3) --- nh*air*P [10^9 is for unit conversions]
# P (7) - nh (11) - afair (16)
amc2 = (parm[,11]*parm[,16]*parm[,7])/(10^9)
save(lpy,lpy2,my,my2,amc,amc2,file="risk_results.RData")
```
MYCOBACTERIA EXTREME ASSESSMENT
```{r}
M2 = c(940000,940000)
parm2 = data.frame(simulateMvMatrix(1000,distributions=c(pair="emp",E="normTrunc",rlp="emp",rm="unif",LP="emp",M="emp",
  P="unif",dep="emp",I="unif",D="emp",nh="unif",LD="emp",MD="emp",aair="emp"),
	param.list=list(pair=list(obs=p),E=list(mean=11.7,sd=4.8,min=0,max=24),rlp=list(obs=rlp),rm=list(min=3.12e-9,max=1.1e-6),
									LP=list(obs=LP),M=list(obs=M2),P=list(min=0.01,max=0.2),dep=list(obs=dep),I=list(min=0.6,max=1.5),D=list(obs=N),
	nh=list(min=500,max=1800),LD=list(obs=LD),MD=list(obs=MD),aair=list(obs=a)),sample.method="LHS",seed=250))
D = round(parm2[,10],0) 
m_d2 = data.frame(1-exp(-parm2[,4]*((parm2[,1]*parm2[,9]*parm[,6]*parm2[,2]*parm2[,8]*parm2[,13])/9.97e8)))
m.year2 = function(m_d2){  
  z = function(D){
    mk = sample(m_d2,D,replace=TRUE)
    myear = 1-prod(1-mk)
  }
  z2 = sapply(D,z)
}
set.seed(487)
my2 = as.numeric(apply(m_d2,2,m.year2))  # annual infection probability with 100% wastewater irrigation
summary(my2)
```
AMMONIA EXTREME ASSESSMENT
```{r}
nh = parm[,11]*10  # multiply ammonia source concentration by 10
amc = (nh*parm[,14]*parm[,7])/(10^9)
summary(amc)  
```
SOBOL SENSITIVITY ANALYSIS
```{r}
x1 = data.frame(simulateMvMatrix(1000,distributions = c(air="unif",I="unif",dep="unif",E="unif",P="unif",L="unif",rlp="unif",
     M="unif",rm="unif",nh="unif",LD="unif",MD="unif"),
		 param.list = list(air=list(min=0,max=1e5),I=list(min=0.6,max=1.5),dep=list(min=0,max=1),E=list(min=0,max=24),
     P=list(min=0,max=1),L=list(min=0,max=1e6),rlp=list(min=0,max=1),M=list(min=0,max=1e6),rm=list(min=0,max=1),
     nh=list(min=0,max=1e6),LD=list(min=0,max=1),MD=list(min=0,max=1)),sample.method = "LHS",seed = 784))
x2 = data.frame(simulateMvMatrix(1000,distributions = c(air="unif",I="unif",dep="unif",E="unif",P="unif",L="unif",rlp="unif",
     M="unif",rm="unif",nh="unif",LD="unif",MD="unif"),
		 param.list = list(air=list(min=0,max=1e5),I=list(min=0.6,max=1.5),dep=list(min=0,max=1),E=list(min=0,max=24),
     P=list(min=0,max=1),L=list(min=0,max=1e6),rlp=list(min=0,max=1),M=list(min=0,max=1e6),rm=list(min=0,max=1),
     nh=list(min=0,max=1e6),LD=list(min=0,max=1),MD=list(min=0,max=1)),sample.method = "LHS",seed = 138))

# Probability of infection per irrigation event model [1-exp(-rm*(air*I*M*E*P*dep*MD)/9.97e8)]
lp.model = function(x){lp = 1-exp(-x[,7]*(x[,1]*x[,2]*x[,6]*x[,4]*x[,5]*x[,3]*x[,11])/9.97e8)}  # Legionella
m.model = function(x){m = 1-exp(-x[,9]*(x[,1]*x[,2]*x[,8]*x[,4]*x[,5]*x[,3]*x[,12])/9.97e8)}  # NTM

# Ammonia air concentration model [nh*air*P]
a.model = function(x){a = (x[,10]*x[,1]*x[,5])/(10^9)}  

# Sobol sensitivity analysis --- first and total order indices (scheme = "A")
LPsa = sobolSalt(model=lp.model,X1=x1,X2=x2,scheme="A",nboot=0,conf=0.95)  # Legionella
Msa = sobolSalt(model=m.model,X1=x1,X2=x2,scheme="A",nboot=0,conf=0.95)  # Mycobacteria
Asa = sobolSalt(model=a.model,X1=x1,X2=x2,scheme="A",nboot=0,conf=0.95)  # Ammonia

# Tables of 1st and total indices with variable designators
lpsa1_v = data.frame(order(LPsa$S,decreasing=TRUE))  # variable order
lpsa1_s = LPsa$S %>% arrange(desc(original))         # score order
lpsat_v = data.frame(order(LPsa$T,decreasing=TRUE))
lpsat_s = LPsa$T %>% arrange(desc(original))
lpsa = cbind(lpsa1_v,lpsa1_s,lpsat_v,lpsat_s)  # both total and 1st indices

msa1_v = data.frame(order(Msa$S,decreasing=TRUE))  # variable order
msa1_s = Msa$S %>% arrange(desc(original))         # score order
msat_v = data.frame(order(Msa$T,decreasing=TRUE))
msat_s = Msa$T %>% arrange(desc(original))
msa = cbind(msa1_v,msa1_s,msat_v,msat_s)  # both total and 1st indices

asa1_v = data.frame(order(Asa$S,decreasing=TRUE))  # variable order
asa1_s = Asa$S %>% arrange(desc(original))         # score order
asat_v = data.frame(order(Asa$T,decreasing=TRUE))
asat_s = Asa$T %>% arrange(desc(original))
asa = cbind(asa1_v,asa1_s,asat_v,asat_s)  # both total and 1st indices
```
DEPOSITION ASSESSMENT
```{r}
rm(list=ls())
##### LOAD AIR CONCENTRATIONS FROM AERMOD
nspath = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/NS_PATH_DEP.PLT",skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
nsam = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/NS_AMMONIA_DEP.PLT",skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
ewpath = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/EW_PATH_DEP.PLT",skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
ewam = read.fwf("C:/Users/brenn/Box Sync/Dispersion Modeling/Round 9/EW_AMMONIA_DEP.PLT",skip=8,width=c(14,14,14,14,14,9,9,9,8,10,10))
save(nspath,nsam,ewpath,ewam,file="rawdepinput.RData")

nsam[nsam==9999999999999] = NA  # recode and remove missing values
nsam = na.omit(nsam)
ewam[ewam==9999999999999] = NA
ewam = na.omit(ewam)

nsp = nspath[,c(3,5,11)] %>% filter(V5==0) 
colnames(nsp) = c("c","wdep","date")
nsp2 = nsp[,c(1,3)] %>% mutate(datetime=ymd_h(date),hour=hour(datetime)) 
nsp3 = nsp2[4321:527040,c(1,3,4)]
nsp3$hour = as.numeric(nsp3$hour)  # change format 
nsp3$c = as.numeric(nsp3$c)  # change format

nsa = nsam[,c(3,5,11)] %>% filter(V5==0) 
colnames(nsa) = c("c","wdep","date")
nsa2 = nsa[,c(1,3)] %>% mutate(datetime=ymd_h(date),hour=hour(datetime)) #%>% select(datetime,hour,c)
nsa3 = nsa2[4321:527040,c(1,3,4)]
nsa3$hour = as.numeric(nsa3$hour)
nsa3$c = as.numeric(nsa3$c)

ewp = ewpath[,c(3,5,11)] %>% filter(V5==0)  
colnames(ewp) = c("c","wdep","date")	
ewp2 = ewp[,c(1,3)] %>% mutate(datetime=ymd_h(date),hour=hour(datetime)) #%>% select(datetime,hour,c)
ewp3 = ewp2[4321:527040,c(1,3,4)]
ewp3$hour = as.numeric(ewp3$hour)
ewp3$c = as.numeric(ewp3$c)

ewa = ewam[,c(3,5,11)] %>% filter(V5==0)
colnames(ewa) = c("c","wdep","date")
ewa2 = ewa[,c(1,3)] %>% mutate(datetime=ymd_h(date),hour=hour(datetime)) #%>% select(datetime,hour,c)
ewa3 = ewa2[4321:527040,c(1,3,4)]
ewa3$hour = as.numeric(ewa3$hour)
ewa3$c = as.numeric(ewa3$c)

##### MEAN AIR CONCENTRATION FOR EACH HOUR
nsp_sum = ddply(nsp2,.(hour),summarize,avg=mean(c))
nsa_sum = ddply(nsa2,.(hour),summarize,avg=mean(c))
ewp_sum = ddply(ewp2,.(hour),summarize,avg=mean(c))
ewa_sum = ddply(ewa2,.(hour),summarize,avg=mean(c))
```
SCENARIO ANALYSES FOR LEGIONELLA SOURCE CONCENTRATION AND PERCENT WASTEWATER
```{r}
rm(list=ls())
load("LHS.RData")
L = seq(0,2000,100) %>% as.numeric()
P = c(0.05,0.1,0.15,0.2)

lp.d = function(L){
	x = parm[,15]*parm[,9]*L*parm[,2]*parm[,8]*parm[,12]
	return(x)
}
set.seed(285)
lpd1 = sapply(L,lp.d)

s = lpd1[,13]  # source concentration column of interest 

lp.d2= function(P){
	lpd1 = lpd1
	x2 = 1-exp(-parm[,3]*((s*parm[,7])/9.97e8))
	return(x2)
}
set.seed(972)
lpd2 = sapply(P,lp.d2)  # each column is a wastewater percentage and every 1000 rows is a single source concentration
N = round(parm[,10],0)  # round number of irrigation events/year to a whole number because it's a discrete variable

p = lpd2[,4]  # percent wastewater column of interest --- 10%

lp.year = function(p){
	z = function(N){
    lpk = sample(p,N,replace=TRUE)   # choose number of single infection probabilities equal to the number of irrigation events for a year 
    lpyear = 1-prod(1-lpk)  # find the product of 1 minus each single infection probability and subtract from 1
  }
  z2 = sapply(N,z)  # get the annual probability of infection for each possible number of irrigation events
}
set.seed(770)
lpy = as.numeric(sapply(p,lp.year)) 
summary(lpy); quantile(lpy,0.95) > 1e-4

### Narrow down the thresholds
L2 = seq(100,200,10)

lp.d = function(L2){
	x = parm[,1]*parm[,9]*L2*parm[,2]*parm[,8]*parm[,12]
	return(x)
}
set.seed(285)
lpd1 = sapply(L2,lp.d)

s = lpd1[,6]  # source concentration column of interest 

lp.d2= function(P){
	lpd1 = lpd1
	x2 = 1-exp(-parm[,3]*((s*parm[,7])/9.97e8))
	return(x2)
}
set.seed(972)
lpd2 = sapply(P,lp.d2)  # each column is a wastewater percentage and every 1000 rows is a single source concentration
N = round(parm[,10],0)  # round number of irrigation events/year to a whole number because it's a discrete variable

p = lpd2[,4]  # percent wastewater column of interest --- 10%

lp.year = function(p){
	z = function(N){
    lpk = sample(p,N,replace=TRUE)   # choose number of single infection probabilities equal to the number of irrigation events for a year 
    lpyear = 1-prod(1-lpk)  # find the product of 1 minus each single infection probability and subtract from 1
  }
  z2 = sapply(N,z)  # get the annual probability of infection for each possible number of irrigation events
}
set.seed(770)
lpy = as.numeric(sapply(p,lp.year)) 
summary(lpy); quantile(lpy,0.95) > 1e-4
```
TESTING SOURCE CONCENTRATION MAXIMUMS
```{r}
L = max(parm$LP)
M = max(parm$M)
A = max(parm$nh)

### Legionella
lpd = 1-exp(-parm[,3]*((parm[,1]*parm[,9]*L*parm[,2]*parm[,7]*parm[,8]*parm[,12])/9.97e8))

D = round(parm[,10],0)  # round number of irrigation events/year to a whole number because it's a discrete variable
lpd2 = data.frame(lpd)
lp.year = function(lpd2){
  z = function(D){
    lpk = sample(lpd2,D,replace=TRUE)   # choose number of single infection probabilities equal to the number of irrigation events for a year 
    lpyear = 1-prod(1-lpk)  # find the product of 1 minus each single infection probability and subtract from 1
  }
  z2 = sapply(D,z)  # get the annual probability of infection for each possible number of irrigation events
}
set.seed(770)
lpy = as.numeric(apply(lpd2,2,lp.year)) 
lpy2 = as.data.frame(lpy)

ggplot(lpy2,aes(x=lpy))+geom_density()

### Mycobacteria
m_d = data.frame(1-exp(-parm[,4]*((parm[,1]*parm[,9]*M*parm[,2]*parm[,7]*parm[,8]*parm[,13])/9.97e8)))
m.year = function(m_d){  # annual infection probability
  z = function(D){
    mk = sample(m_d,D,replace=TRUE)
    myear = 1-prod(1-mk)
  }
  z2 = sapply(D,z)
}
set.seed(770)
my = as.numeric(apply(m_d,2,m.year))
my2 = as.data.frame(my)

ggplot(my2,aes(x=my))+geom_density()

### Ammonia
amc = (A*parm[,14]*parm[,7])/(10^9)
amc2 = as.data.frame(amc)

ggplot(amc2,aes(x=amc))+geom_density()
```